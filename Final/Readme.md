# Home

1. [Introduction](#introduction)
2. [Dataset](#dataset)
3. [Terminology Used](#terminology-used)
4. [Features](#features)
5. [Feature Engineering](#feature-engineering)
6. [Models](#models)
7. [Conclusion](#conclusion)

# Introduction

![Baseball](https://media.istockphoto.com/id/1190211599/vector/baseball-game-flat-banner-vector-template.jpg?s=612x612&w=0&k=20&c=7HdDIMrU34GievWhJqCZC_z0vEyIf0Q1XupVs4ZwBqI=)

### <a href="https://en.wikipedia.org/wiki/Baseball#History" target="_blank">Baseball</a>

The main objective of this project is to predict whether HomeTeam wins for a baseball game.
This would provide insight and analysis to fans, bettors, and analysts. By using statistical models and historical
data , predictions can help individuals make informed decisions when it comes to betting on games or simply just to
understand the potential outcome.

![Betting](https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSdj_OUQmcOUG9ZzbF8dipBXVPe-7fzYopW3g&usqp=CAU)

Based on historical data from 2008 to 2012, several features have been engineered using the baseball statistics
from <a href="https://en.wikipedia.org/wiki/Baseball_statistics" target="_blank">Wikipedia</a> and
<a href="https://www.mlb.com/glossary/advanced-stats" target="_blank">MLB</a>. I will discuss how these features
have been developed in detail later in this project, some performed good and most not so good. That is how it is,
creating anything that relate to our objective and testing whether it is actually good, would yield better
results.

One of the top priorities is the reproducibility of this project with the exact results that have been discussed
below. Code has been developed in Python, and Mariadb was used to play with the data, loading the dataset, and
creating features. Reproducibility is ensured by setting this entire project to run in docker. Cloning this
repository and running

`docker-compose up`

will build the required docker images, run the containers, and generate the output
inside your repo to `Backup/Output`

# Dataset

The dataset has been provided in class BDA-602 by the course instructor. Link to download the
<a href="https://teaching.mrsharky.com/data/baseball.sql.tar.gz" target="_blank">Baseball Dataset</a>.

The parent table has all info of each game that is in the data play by play. To our convenience, all the game
metrics have been grouped into different tables already in the dataset. Few tables that have been used for
our purpose in this project are `boxscore`, `game`, `pitcher_counts`, and `team_batting_counts`.

As in any dataset, this has issues too. For example, the target variable HomeTeamWins `HTWins` was supposed to be
generated from `boxscore.winner_home_or_away`.
But the data it has, is incorrect. Some rows do not match winner with their respective runs(not always greater).
Hence, target variable was generated using `boxscore.home_runs` and `boxscore.away_runs`. Only when home team runs
are greater, it was considered that home team won or 1, rest of the conditions equal or less is considered 0.

The data in columns about Caught Stealings and Stolen bases in all tables are all zeroes. They could be built from
innings table, but any features that require these columns are avoided in my project.

There are duplicate columns like forceout & force_out, flyout & fly_out, and lineout & line_out. They should be
combined(added) to use in any feature. As sometimes data is missing in forceout, only has zeroes, but same rows have
data in force_out, and rest of rows are all zeroes where the former had data. Hence, combining them would be
good approach. Similarly, for other columns mentioned. I have highlighted more mistakes in the data in the coming
sections, wherever applicable.

# Terminology Used

All the SQL Code uses the general Baseball terminology.

`H` - Hits\
`K` - Strike Out\
`AB` - AtBats\
`HR` - HomeRun\
`BB` - Bases on Balls or Walks\
`BF` - Batters Faced\
`PT` - Pitches Thrown\
`IP`- Innings Pitched\
`1B` - Single\
`2B` - Double\
`3B` - Triple\
`TB` - Total Bases\
`RA` - Runs Allowed\
`RS` - Runs Scored\
`IBB` - Intentional Walks\
`HBP` - Hit By Pitch\
`PTB` - Pitcher's Total Bases\
`HTRuns` - HomeTeam Runs\
`ATRuns` - AwayTeam Runs\
`HTWins` - HomeTeam Wins

Feature name structure:\
`{SP/TP/TB/TM}_{Feature}_DIFF_{HIST/ROLL}`

`SP` - Starting Pitcher Features\
`TP` - Team Pitching Features\
`TB` - Team Batting Features\
`TM` - Team General Features

`DIFF` - To denote that the feature is generated by difference of home team and away stats.\
`HIST` - Feature generated from all games before that game.\
`ROLL` - Feature generated from 100 games (rolling) before that game.

# Features

All features used are generated using:

- [Starting Pitcher Statistics](#pitcher-statistics)
- [Team Batting Statistics](#batter-statistics)
- [Team Pitching Statistics](#pitcher-statistics)
- [Team General Statistics](#team-statistics)

## Pitcher Statistics

All the statistics used for pitcher are applied for both the starting pitcher in team, and also the entire team
pitching. Although, only starting pitcher features are found to be useful, and team pitching features are not.
As, we are doing a prediction model, only games before that particular game is used for generating below stats.

#### 1. <a href="https://en.wikipedia.org/wiki/Bases_on_balls_per_nine_innings_pitched" target="_blank">BB9</a>

BB9 - BB/9 or Bases on balls per nine innings pitched

![BB9](https://wikimedia.org/api/rest_v1/media/math/render/svg/f5b6848533d6f61b342f22852807121e3ba72707)

#### 2. <a href="https://en.wikipedia.org/wiki/Batters_faced" target="_blank">BFP</a>

Total Batters Faced (TBF) or Batters Facing Pitcher (BFP): opponent team's total plate appearances

#### 3. <a href="https://en.wikipedia.org/wiki/Component_ERA" target="_blank">CERA</a>

CERA – Component ERA: an estimate of a pitcher's ERA based upon the individual components of his
statistical line (K, H, 2B, 3B, HR, BB, HBP)

![CERA](https://wikimedia.org/api/rest_v1/media/math/render/svg/90209c1cbb46b9f7b4c394bd8632de4308425ed9)

#### 4. <a href="https://en.wikipedia.org/wiki/Defense_independent_pitching_statistics" target="_blank">FIP</a>

FIP – Fielding independent pitching: a metric, scaled to resemble an ERA, that focuses on events within the
pitcher's control – home runs, walks, and strikeouts – but also uses in its denominator the number of outs the
team gets (see IP), which is not entirely within the pitcher's control.

![FIP](https://wikimedia.org/api/rest_v1/media/math/render/svg/f1e191329c2186b86bd563a0c50a30d6b7e37177)

#### 5. <a href="https://en.wikipedia.org/wiki/Hits_per_nine_innings" target="_blank">HA9</a>

H/9 (or HA/9) – Hits allowed per 9 innings pitched: hits allowed times nine divided by innings pitched
(also known as H/9IP)

![HA9](https://wikimedia.org/api/rest_v1/media/math/render/svg/1a02a83ef130a1e00ea85b76ecca163ee84fec65)

#### 6. <a href="https://en.wikipedia.org/wiki/Home_runs_per_nine_innings" target="_blank">HRA9</a>

HR/9 (or HRA/9) – Home runs per nine innings: home runs allowed times nine divided by innings pitched
(also known as HR/9IP)

![HRA9](https://wikimedia.org/api/rest_v1/media/math/render/svg/437d0aeb49cdfbc653e4066ef025e0b4ff2dda6d)

#### 7. <a href="https://en.wikipedia.org/wiki/Innings_pitched" target="_blank">IP</a>

IP – Innings pitched: the number of outs a team gets while a pitcher is pitching divided by 3

#### 8. <a href="https://en.wikipedia.org/wiki/Strikeouts_per_nine_innings_pitched" target="_blank">SO9</a>

K/9 (or SO/9) – Strikeouts per 9 innings pitched: strikeouts times nine divided by innings pitched

![SO9](https://wikimedia.org/api/rest_v1/media/math/render/svg/c121d6e8aa361b84119cd4154c246cc1f715f2f8)

#### 9. <a href="https://en.wikipedia.org/wiki/Strikeout-to-walk_ratio" target="_blank">SWR</a>

K/BB (or SO/BB) – Strikeout-to-walk ratio: number of strikeouts divided by number of base on balls

![SWR](https://wikimedia.org/api/rest_v1/media/math/render/svg/84fb775c0233dd0682348ddec8347cff3c4798c5)

#### 10. <a href="https://en.wikipedia.org/wiki/Batting_average_against" target="_blank">OBA</a>

OBA (or BAA) – Opponents batting average: hits allowed divided by at-bats faced

![OBA](https://wikimedia.org/api/rest_v1/media/math/render/svg/70cab89fb97c16f11148b8fe76311fe098fffb09)

#### 11. <a href="https://en.wikipedia.org/wiki/Power_finesse_ratio" target="_blank">PFR</a>

PFR – Power finesse ratio: The sum of strikeouts and walks divided by innings pitched.

PFR = (Strike Outs + Walks)/Innings Pitched

#### 12. <a href="https://en.wikipedia.org/wiki/Walks_plus_hits_per_inning_pitched" target="_blank">WHIP</a>

WHIP – Walks and hits per inning pitched: average number of walks and hits allowed by the pitcher per inning

![WHIP](https://wikimedia.org/api/rest_v1/media/math/render/svg/2c7b9b30611211c0392c356b4f3a1dbecc670064)

#### 13. SOPP

Strike Out Percentage or SOPP is calculated as the strike outs divided by Pitches Thrown.

`SOPP = Strike Outs/Pitches Thrown`

#### 14. RAA

Average of Runs Allowed or RAA is calculated as the Runs Allowed per nine innings pitched.

Runs Allowed is calculated as ((Hits + Walks) x Total Bases) ÷ (At Bats + Walks)

`RAA = 9 * Runs Allowed/Innings Pitched`

As there is not enough data or methods to determine Earned Runs, This custom calculation was used instead.

## Batter Statistics

#### 1. <a href="https://en.wikipedia.org/wiki/Batting_average_(baseball)" target="_blank">AVG</a>

BA – Batting average (also abbreviated AVG): hits divided by at bats (H/AB)

![AVG](https://wikimedia.org/api/rest_v1/media/math/render/svg/b1a9a962a9a544aa68480dfacb4a5d4f63ff92c0)

#### 2. <a href="https://en.wikipedia.org/wiki/Batting_average_on_balls_in_play" target="_blank">BABIP </a>

BABIP – Batting average on balls in play: frequency at which a batter reaches a base after putting the
ball in the field of play. Also, a pitching category.

![BABIP](https://wikimedia.org/api/rest_v1/media/math/render/svg/becbd42dc45a0c77096f388ec84c0e3f66380922)

#### 3. <a href="https://en.wikipedia.org/wiki/On-base_percentage" target="_blank">OBP</a>

OBP – On-base percentage: times reached base (H + BB + HBP) divided by at bats plus walks plus hit by pitch plus sacrifice flies (AB + BB + HBP + SF)

![OBP](https://wikimedia.org/api/rest_v1/media/math/render/svg/d497b106820c509fa8baa93f3c42cc5087fb0fea)

#### 4. <a href="https://en.wikipedia.org/wiki/Slugging_percentage" target="_blank">SLG</a>

SLG – Slugging percentage: total bases achieved on hits divided by at-bats (TB/AB)

![SLG](https://wikimedia.org/api/rest_v1/media/math/render/svg/adcf1ebdff1be4abc34a5942513e051cdc4dd284)

#### 5. <a href="https://en.wikipedia.org/wiki/On-base_plus_slugging" target="_blank">OPS</a>

OPS – On-base plus slugging: on-base percentage plus slugging average

![OPS1](https://wikimedia.org/api/rest_v1/media/math/render/svg/d2f05248e44c0ea077112665a20de975cc625f8e)

![OPS2](https://wikimedia.org/api/rest_v1/media/math/render/svg/367a75a5c5745cb8c41d8d351e4a1016c2b9f205)

## Team Statistics

#### 1. <a href="https://www.samford.edu/sports-analytics/fans/2022/MLB-Winning-Percentage-Breakdown-Which-Statistics-Help-Teams-Win-More-Games" target="_blank">RD</a>

Run Differential: Run differential is calculated by subtracting how many runs were allowed from how many runs a team scored.

`RD = RS - RA`

#### 2. <a href="https://en.wikipedia.org/wiki/Pythagorean_expectation" target="_blank">PYEX</a>

Pythagorean expectation: estimates a team's expected winning percentage based on runs scored and runs allowed

![PYEX](https://wikimedia.org/api/rest_v1/media/math/render/svg/e1d73404fdcf826af1a8d4f71bc8ae02b5a44136)

#### 3. <a href="https://www.samford.edu/sports-analytics/fans/2022/MLB-Winning-Percentage-Breakdown-Which-Statistics-Help-Teams-Win-More-Games" target="_blank">WP</a>

WP - Win Percentage: Number games won before by total numbers of games played

# Feature Engineering

- All features have been created in SQL using above formulas. Then loaded to pandas dataframe using SQLAlchemy library.

- All columns except game id, game date and HTWins had some null values. As we are using games before a particular to
  get stats till that game, when the data is missing for a teams first match in our data, we get null values.\

- Also while doing mathematical operations to generate features on rows having null, values, result will be a null too.
  This is more pronounced for starting pitcher features as many starting features may not any data before their first
  game(in the data available).

- So, these missing values are handled by carefully filling with median values of training data.
  The dataframe is first ordered by game date and game id. and then split into 60:40 ratio for training
  and testing sets, so that we don't reveal any future data to the model. Now the median values of training data is used
  to fill nans in training and testing data.

- These nans handled data is concatenated and passed to report generator function available in
- generator module to get the predictor reports.

Feature Engineering is done in three steps after feature generation:

### Predictor report Analysis

The predictor report is generated in the form of html where all features are seperated for continuous and
categorical types. Get p values, t scores and random forest variable importance for the continuous predictor types.
Weighted and Unweighted mean of responses for both categorical and continuous predictors with their respective
pattern plots and mean of response plots.
\
\
![Image1](https://github.com/Vijaybhk/images/blob/main/Baseball/Image1.png)
\
\
p-values and t-scores are generated by doing logistic regression for categorical response and
linear regression for continuous response, with each variable against the target variable.
\
Random Forest Variable Importance scores are generated through random forest regressor or classifier depending
on the type of response. (In this case, it is categorical.)\
\
Weighted Mean of response is calculated by dividing the continuous predictor into ten bins, and
calculating it through ∑𝑖=1𝑖≤𝑛𝑤𝑖(𝜇𝑖−𝜇𝑝𝑜𝑝)2\
\
Distribution Plots and Violin Plots are generated for the continuous predictors and categorical response type.
The code developed in this project also support additional types, but all features we have are continuous and
response as categorical. So, we discuss only on those conditions further.\
\
One of the best predictor that have been highly ranked, for p values, t scores, random forest variable importance,
and the weighted mean of response is the Run differential. It was added to this project only after certain time,
but adding it has improved the performance tremendously. It has very clear pattern and is very predictive.\
\
![Image2](https://github.com/Vijaybhk/images/blob/main/Baseball/Image2.png)\
\
![Image3](https://github.com/Vijaybhk/images/blob/main/Baseball/Image3.png)\
\
![Image4](https://github.com/Vijaybhk/images/blob/main/Baseball/Image4.png)

### Correlation Analysis

Correlation coefficients are also generated in the predictor reports, which has a correlation matrix,
and correlation coefficients for each combination of features.

![Image5](https://github.com/Vijaybhk/images/blob/main/Baseball/Image5.png)

When testing models with predictors, few may turn productive and turn good performance,
but removing correlated variables does not decrease the accuracy, but improves model's efficiency.
Highly correlated variables convey no extra information, we can have just one of them and model would perform
same, if not better.

When testing different predictor combinations SP_IP_DIFF_ROLL and SP_BFP_DIFF_ROLL have turned out be predictive,
and good performing. But it was found later that, both are highly correlated with correlation pearson's r of 0.992914.
It means that both variables convey the models same information.

![Image6](https://github.com/Vijaybhk/images/blob/main/Baseball/Image6.png)

In choosing to remove one of them, Observing the mean of response plots, SP_IP_DIFF_ROLL had little wavy trend but
SP_BFP_DIFF_ROLL has upward trend. Using only SP_BFP_DIFF_ROLL is a wise option. when tested, some models performed same.
some improved. To ensure it was the right choice, replaced and tested, and the found models dropped accuracy.
Ultimately, it was right choice.

Several, of these combination replacements have been tried, in bringing the best results possible.

### Brute Force Analysis

A brute force approach is an approach that finds all the possible solutions to find a satisfactory solution to a
given problem. All combinations of features with each one of them are clearly examined, to see if there is a pattern
and see if any new feature could be generated through combining them together, by verifying after if they are not
correlated.

![Image7](https://github.com/Vijaybhk/images/blob/main/Baseball/Image7.png)

Above is the sample brute force analysis graph generated between two features, there is no clear pattern in it.
There are a few possible positions which shows pattern, but the combinations of those are already present as a
different feature.

# Models

Initially when some best performing features were not created, the models were as good as a random
guess. When features like the Run differential, Pythagorean Expectation, and Fielding independent pitching were
added, the models performed. Also, addition of new model like the AdaBoost, XGBoost, and KNN also did good.

Adaboost, and XGBoost were consistently generating good accuracies, when tried with different predictor combinations.

Finally, Logistic Regression, Random Forest, KNearest Neighbors Classifier, Decision tree, Bagging Tree,
Ada Boost, and XGBoost were used to compare and select the best performing.

As a First attempt, when all the features were thrown at the model, the results were as follows:

![Image8](https://github.com/Vijaybhk/images/blob/main/Baseball/Image8.png)

Later, by carefully observing the predictor plots and scores generated through report, tried various combinations
and compared the model performances.

Intermediate results:

![Image9](https://github.com/Vijaybhk/images/blob/main/Baseball/Image9.png)

Finally, the models performed well with just eight good and non correlated features.

`SP_BFP_DIFF_ROLL`, `SP_FIP_DIFF_HIST`, `SP_SO9_DIFF_ROLL`, `SP_SOPP_DIFF_HIST`

`TB_BABIP_DIFF_ROLL`, `TB_OPS_DIFF_HIST`

`TM_PYEX_DIFF_HIST`, `TM_RD_DIFF_ROLL`

Results of the Final Models:

![Image10](https://github.com/Vijaybhk/images/blob/main/Baseball/Image10.png)

Adaboost and Logistic Regression were always the top performing models. The final iteration of modeling has
**Adaboost** at accuracy of **56.87%** and **Logistic Regression** at **56.73%**.

ROC Curves of Final Models:

![Image11](https://github.com/Vijaybhk/images/blob/main/Baseball/Image11.png)

Confusion Matrices of Adaboost and Logistic Regression:

![Image12](https://github.com/Vijaybhk/images/blob/main/Baseball/Image12.png)\
\
![Image13](https://github.com/Vijaybhk/images/blob/main/Baseball/Image13.png)

# Conclusion

All the metrics like Accuracy, ROC Curves AUC Score, Mean Absolute Error, Precision and Matthews Coefficient suggests
that Adaboost is the best performing model. But recall, f1 score and confusion suggest that Logistic Regression predicts
more wins.
